name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    - name: Restore
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore -c Release

    - name: Run tests (produce TRX)
      run: |
        mkdir TestResults 2>$null
        dotnet test --no-build -c Release --logger "trx;LogFileName=test_results.trx" --results-directory TestResults --verbosity minimal
      shell: powershell
      continue-on-error: true

    - name: Upload test results artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/**/*.trx

    - name: Generate test summary
      if: always()
      run: |
        mkdir TestResults 2>$null
        $summary = "## Test Results Summary`n`n"
        $failed = 0; $total = 0; $passed = 0; $skipped = 0
        Get-ChildItem -Path TestResults -Filter *.trx -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
          try {
            $xml = [xml](Get-Content $_.FullName)
            $results = $xml.TestRun.Results.UnitTestResult
            if ($null -eq $results) { $count = 0 } elseif ($results -is [System.Array]) { $count = $results.Length } else { $count = 1 }
            $total += $count
            $f = ($results | Where-Object { $_.outcome -eq 'Failed' } | Measure-Object).Count
            $p = ($results | Where-Object { $_.outcome -eq 'Passed' } | Measure-Object).Count
            $s = ($results | Where-Object { $_.outcome -eq 'NotExecuted' -or $_.outcome -eq 'Skipped' } | Measure-Object).Count
            $failed += $f; $passed += $p; $skipped += $s
            $summary += "### File: $($_.FullName)`nTotal: $count, Passed: $p, Failed: $f, Skipped: $s`n`n"
          }
          catch {
            $summary += "### File: $($_.FullName)`nFailed to parse TRX: $($_.Exception.Message)`n`n"
          }
        }
        $summary += "`n**Overall:** Total=$total, Passed=$passed, Failed=$failed, Skipped=$skipped`n"
        $summary | Out-File -FilePath TestResults/TestSummary.md -Encoding utf8
      shell: powershell

    - name: Upload test summary artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: TestResults/TestSummary.md

    - name: Fail job if tests failed
      if: always()
      run: |
        $failed = 0
        Get-ChildItem -Path TestResults -Filter *.trx -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
          $content = Get-Content $_.FullName -Raw
          if ($content -match '<Result>Failed</Result>' -or $content -match 'failed="[1-9]') { $failed++ }
        }
        if ($failed -gt 0) { Write-Host "Found failed tests in $failed TRX file(s)."; exit 1 }
      shell: powershell

    - name: Publish WinForms app (single-file)
      run: |
        dotnet publish Dnp.S3.Manager.WinForms/Dnp.S3.Manager.WinForms.csproj -c Release -r win-x64 -o ./artifacts/winforms/publish --self-contained true /p:PublishSingleFile=true /p:IncludeAllContentForSelfExtract=true /p:PublishTrimmed=false

    - name: Zip published WinForms
      run: |
        powershell -Command "Compress-Archive -Path './artifacts/winforms/publish/*' -DestinationPath './artifacts/Dnp.S3.Manager.WinForms.zip' -Force"

    - name: Determine next semantic release tag
      if: github.event_name == 'push'
      id: version
      uses: actions/github-script@v6
      with:
        script: |
          const latest = await github.rest.repos.getLatestRelease({ owner: context.repo.owner, repo: context.repo.repo }).catch(e => null);
          let next;
          if (!latest || !latest.data || !latest.data.tag_name) {
            next = '0.25.0';
          } else {
            let tag = latest.data.tag_name.replace(/^v/, '');
            const parts = tag.split('.').map(p => parseInt(p, 10));
            if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
              parts[2] = parts[2] + 1; // increment patch
              next = parts.join('.');
            } else if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              // treat as major.minor, append .0 then increment
              next = `${parts[0]}.${parts[1]}.0`;
            } else {
              next = '0.25.0';
            }
          }
          core.setOutput('next_tag', next);
          return { next_tag: next };

    - name: Create GitHub release
      if: github.event_name == 'push'
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: v${{ env.VERSION }}
        release_name: Release ${{ env.VERSION }}
        body: |
          Automated release created by CI for version ${{ env.VERSION }}.
        draft: false
        prerelease: false
      env:
        VERSION: ${{ steps.version.outputs.next_tag }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload WinForms artifact to release
      if: github.event_name == 'push'
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/Dnp.S3.Manager.WinForms.zip
        asset_name: Dnp.S3.Manager.WinForms-v${{ steps.version.outputs.next_tag }}.zip
        asset_content_type: application/zip
        repo_token: ${{ secrets.GITHUB_TOKEN }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
