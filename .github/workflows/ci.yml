name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    - name: Restore
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore -c Release
    - name: Run tests
      run: dotnet test --no-build -c Release --verbosity normal
    
    - name: Publish WinForms app (single-file)
      run: |
        dotnet publish Dnp.S3.Manager.WinForms/Dnp.S3.Manager.WinForms.csproj -c Release -r win-x64 -o ./artifacts/winforms/publish --self-contained true /p:PublishSingleFile=true /p:IncludeAllContentForSelfExtract=true /p:PublishTrimmed=false

    - name: Zip published WinForms
      run: |
        powershell -Command "Compress-Archive -Path './artifacts/winforms/publish/*' -DestinationPath './artifacts/Dnp.S3.Manager.WinForms.zip' -Force"

    - name: Determine next semantic release tag
      id: version
      uses: actions/github-script@v6
      with:
        script: |
          const latest = await github.rest.repos.getLatestRelease({ owner: context.repo.owner, repo: context.repo.repo }).catch(e => null);
          let next;
          if (!latest || !latest.data || !latest.data.tag_name) {
            next = '0.25.0';
          } else {
            let tag = latest.data.tag_name.replace(/^v/, '');
            const parts = tag.split('.').map(p => parseInt(p, 10));
            if (parts.length === 3 && !isNaN(parts[0]) && !isNaN(parts[1]) && !isNaN(parts[2])) {
              parts[2] = parts[2] + 1; // increment patch
              next = parts.join('.');
            } else if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              // treat as major.minor, append .0 then increment
              next = `${parts[0]}.${parts[1]}.0`;
            } else {
              next = '0.25.0';
            }
          }
          core.setOutput('next_tag', next);
          return { next_tag: next };

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: v${{ steps.version.outputs.next_tag }}
        release_name: v${{ steps.version.outputs.next_tag }}
        body: Automated release generated by CI
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload WinForms artifact to release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/Dnp.S3.Manager.WinForms.zip
        asset_name: Dnp.S3.Manager.WinForms-v${{ steps.version.outputs.next_tag }}.zip
        asset_content_type: application/zip
